---
title: "climate_data_canton_polygons"
author: "Isabel Fletcher"
date: "13/08/2018"
output: html_document
---

## Assigning climate data to district-level resolution ##
# This script is for processing a single climate variable downladed from Climate Explorer (https://climexp.knmi.nl/start.cgi), in netcdf format.
# First, this script extracts a shapefile for an area of interest and creates a raster of this.
# Then the climate data is read in and subsetted to the years of interest. 
# Climate data is extracted from the netcdf into a vector for each year of interest.
# The values of the raster (area of interest) are assigned data from the climate variable. This is done by disaggregating the raster into a higher resolution and filling each timepoint raster with climate data.
# District(canton)-level climate is obtained, using a weighted average of climate values per canton, by calculating the mean of the climate values of all the cells within each canton/district. This is iterated for all timepoints of interest. 
# Finally, a dataframe is produced containing climate data for each canton/district, for all timepoints of interest. 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(maptools)
library(raster)
library(dplyr)
library(ncdf4)
```

## Obtain shapefile to extract data for 
```{r}
# Extent of area of interest
eloro_ext <- extent(c(-80.5, -79.1, -4.0, -2.5))

# Shapefile we want to extract data for
ecuador <- getData('GADM', country = "ECU", level = 2)

## Subset to El Oro
el_oro <- ecuador[ecuador$NAME_1=="El Oro",]
```

## Create raster of El Oro
```{r}
# Crop from world map 
data("wrld_simpl")
crs = projection(wrld_simpl)
ras = raster(eloro_ext, resolution = 0.5, crs = crs)
```

## Read in climate data and extract an array for first year 
```{r}
# Read in climate data
ncname <- "cru_ts4.01.1901.2016.tmn.dat_-80.4--78.8E_-4.0--2.5N" 
ncpath <- "input/spatial/tmin_CRU/"
ncfname <- paste(ncpath, ncname, ".nc", sep = "")
dname <- "tmn"

## Open
ncin <- nc_open(ncfname)

## Extract lat and lon
long <- ncvar_get(ncin,"lon")
lat <- ncvar_get(ncin,"lat")

array <- ncvar_get(ncin, "tmn")
dimnames(array) <- list(long = long, lat = lat)

tmn_vec <- as.vector(array[,,1])
```

## Subset time dimensions (n = 1392)
```{r}
time <- ncvar_get(ncin,"time")

dim(time) 
```

## Extract 31 years of data 1986-2016
```{r}
# 372 time points: extract from 1021-1392
array_data <- array[,,1021:1392]
```

## Iterate through all of array to create a vector of data for each year
```{r}
array_data_dim <- dim(array_data)

tmn_vec_data <- vector("list", 9)

for (i in 1:array_data_dim[3]) {
  tmn_vec_data[[i]] <- as.vector(array_data[,,i])
}
```

## Assign values of raster to climate data
```{r}
# Function to assign values of climate data to raster

assign_ras_data <- function(timepoint) {
                   ## Create vector from array
                   tmn_vec_data[[timepoint]] <- as.vector(array_data[,,timepoint])
                   
                   ## Set values of raster to climate data
                   values(ras) = tmn_vec_data[[timepoint]]
          
                   return(ras)
}

```

## Create a raster layer for each timepoint and fill with climate data
```{r}
## Create empty stack
ras_stack <- stack()

## Iterate through all timepoints to add to each layer
for (i in 1:array_data_dim[3]) {
  x <- assign_ras_data(i)
  
  ## Disaggregate raster into higher resolution
  x1 <- disaggregate(x, fact = 50) 
  
  ## Combine all layers into a single stack
  ras_stack <- stack(x1, ras_stack)
  
}

```

## Access a single layer/timepoint
```{r}
## Check by plotting 
plot(raster(ras_stack, layer = 1))
plot(el_oro, add = TRUE)
```

## Create 'canton ID' field for shapefile to extract
```{r}
el_oro$ID = 1:nrow(el_oro)
```

## Iterate through all cantons and extract data - in this case the mean and sd for each canton
```{r}
## Create empty object 
climatedata <- vector("list", 14)


## Iterate through all timepoints of data
for (i in 1:array_data_dim[3]) {
  ## Function to get raster values for each canton
  getRasterVals = function(x){
  
  # gets canton x of n
  canton = el_oro[el_oro$ID == x, ]
  
  # mask raster to get only the cells within that canton
  ras_mask = mask(raster(ras_stack, layer = i), canton)
  
  # stuff to return
  df = data.frame(ID = x,
                  canton = canton$NAME_2)
  df$Mean = cellStats(ras_mask, "mean")
  df$SD = cellStats(ras_mask, "sd")
  
  # Return df
  return(df)
  }
  
  ## Apply across all cantons
  climatedata[[i]] = do.call(rbind.data.frame, lapply(1:nrow(el_oro), getRasterVals))

}

```

## Combine all data into a single dataframe 
```{r}
## Combine
climatedata <- do.call(rbind, climatedata)

```

## Add timepoints and organise
```{r}
## Add timepoints (372 *14 cantons)
climatedata$Year  <- c(rep(1986:2016, each = 168))
climatedata$Month <- c(rep(rep(1:12, each = 14), 31))

# Remove ID column
climatedata$ID <- NULL

```

## Export data
```{r}


```


